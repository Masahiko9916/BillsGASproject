/**
 * Config.gs V4.2 - 設定ファイル
 * - 新しいステータス「担当者変更あり」を追加
 */

const STATUS = {
  // デフォルト & 手動設定
  UNHANDLED: '未対応',
  HOLD: '保留中',
  
  // 実行待ち（自動処理対象）
  CALENDAR_REGISTER: 'カレンダー登録待ち',
  RESYNC_REGISTER: '更新待ち',
  CANCEL_REGISTER: '取消待ち',
  ASSIGNEE_CHANGE_REGISTER: '担当者変更登録',
  
  // 実行完了
  CALENDAR_COMPLETE: '登録完了',
  RESYNC_COMPLETE: '更新完了',
  CANCEL_COMPLETE: '取消済み',
  ASSIGNEE_CHANGE_COMPLETE: '担当者変更（完了）',
  
  // カレンダーからの変更検知
  ASSIGNEE_CHANGED_FROM_CAL: '担当者変更あり', // ★ 新規追加
  
  // エラー・削除
  ERROR: 'エラー',
  CALENDAR_DELETED: '現場側削除',
  ADMIN_DELETED: '管理側削除'
};

/**
 * システム設定（編集してください）
 */
const CONFIG = {
  tz: 'Asia/Tokyo',
  
  // ▼「定期回収」シート（登録SS）
  regSpreadsheetId: '1fKURyzCBlw5gTSBOW9QmeFLyiwj9KICBsEt2TbWrrEQ',
  regSheetName: '定期回収',
  
  // ▼ Chat Webhook（Google Chat 受信用）
  chatWebhookUrl: 'https://chat.googleapis.com/v1/spaces/AAAATEi1Nc4/messages?key=AIzaSyDdI0hCZtE6vySjMm-WEfRq3CPzqKqqsHI&token=abYURuwKwxFcuzCyNAWNxUltBrqlr0XmCb0YOrGStI',
  
  // ▼ 既定カレンダー（後方互換・未設定行のフォールバック用）
  calendarId: 'primary',
  eventColor: 'PALE_GREEN',
  reminderMinutes: 30,
  
  // ▼ メンション（任意）
  chatMentionUser: '',
  chatMentionOnKinds: ['カレンダー登録完了','カレンダー登録通知'],
  
  // ▼ onSubmit後の自動ソート
  sortAfterSubmit: true,
  sortSpec: [{ header: 'タイムスタンプ', ascending: false }],
  
  // ▼ カレンダー差分同期（Calendar API）
  initialLookbackDays: 7,
  createRowIfNotExists: false,
  PROP_SYNC_TOKEN_PREFIX: 'CAL_SYNC_TOKEN',
  
  // ▼ 同期の安全カットオフ（過負荷防止）
  SYNC_LIMITS: {
    maxCalendarsPerRun: 20,
    maxPagesPerCalendar: 3,
    maxEventsPerRun: 500
  },
  
  // ▼ 顧客マスタ（電話番号キー）
  customerSpreadsheetId: '1Uux-oNqaG0fMFzPSplTtO3kx_OENYgdOkVyPR2IVyTg',
  customerSheetName: '医院顧客データ',
  firstUseQuestionHeader: '定期回収のご依頼について',
  firstUseFirstLabel: '初めてのご利用',
  
  // ▼ 担当者マスタ（同一SS内）
  assigneeSheetName: '担当者マスタ',
  assigneeNameHeader: '担当者名',
  assigneeEmailHeader: 'メールアドレス',
  
  // ▼ エリアマスタシート名
  areaMasterSheetName: 'エリアマスタ',
  
  // ▼ 自動処理設定（Ver4で追加）
  AUTO_PROCESS: {
    maxProcessPerRun: 10,  // 1回の実行で処理する最大件数
    lockTimeout: 300000    // ロックタイムアウト（5分 = 300000ミリ秒）
  }
};

/**
 * スポット回収の設定
 */
const SPOT_CONFIG = {
  // フォームのスプレッドシートID
  forms: {
    clinic: '1-ottOFBbVwGO8jQgDPW82cWYq1U5sCssn8eD8Rw658w',
    dealer: '1x2mGYZUn6xnjP1M6sjFtHC5Sk3_XttvVuFicy8Kkes0'
  },
  
  // 管理シート名
  sheets: {
    clinic: 'スポット回収_医院',
    dealer: 'スポット回収_ディーラー'
  },
  
  // 通知先Webhook URL（種別ごと）
  webhooks: {
    clinic: 'https://chat.googleapis.com/v1/spaces/AAQAZRylgLk/messages?key=AIzaSyDdI0hCZtE6vySjMm-WEfRq3CPzqKqqsHI&token=Nzogl2wEv8FTDetJ4_bPxSJtsA6xZnrqHbE7WxYOaew',
    dealer: 'https://chat.googleapis.com/v1/spaces/AAQA8IiQCrE/messages?key=AIzaSyDdI0hCZtE6vySjMm-WEfRq3CPzqKqqsHI&token=z8WikIWDzAq8rt1_Crh1iqy8U5S8jyts70zEzWZ2Tes'
  },
  
  // 初回利用判定用
  firstUseQuestionHeader: '今回のご依頼についてお教えください',
  firstUseFirstLabel: '初めてのご利用'
};

/**
 * ディーラーマスタの設定
 */
const DEALER_CONFIG = {
  spreadsheetId: '1Uux-oNqaG0fMFzPSplTtO3kx_OENYgdOkVyPR2IVyTg',
  sheetName: '【ディーラー】顧客データ',
  keyHeader: 'ディーラー電話番号'
};

/**
 * ヘッダー定義
 */

// 管理列（A～G固定）
const MGMT_HEADERS = [
  'ステータス','回収予定日','開始時間','終了時間',
  '回収担当者','エリア','受付連絡ステータス'
];

// フォーム列（H列以降）- 定期回収用
const FORM_HEADERS = [
  'タイムスタンプ','メールアドレス','電話番号','医院名','担当者名','郵便番号','住所',
  '休診日','午前休診','午後休診','回収不可能時間',
  '50L容器','30L容器','20L容器','感染性廃棄物','廃棄物種類','廃プラ袋',
  '印象歯袋','写真1','ガラス袋','石膏くず袋',
  '定着液','現像液','金属くず袋',
  '対応について','不要品詳細','備考'
];

// ★★★ 修正箇所 START ★★★
// システム列を分割
const SYS_HEADERS_MAIN = [
  '受付ID','行URL',
  '最終更新者','最終更新時刻','削除日時','削除元','最終更新元'
];

// カレンダー関連のシステム列
const CALENDAR_HEADERS = [
  'カレンダーイベントID','カレンダーID'
];
// ★★★ 修正箇所 END ★★★


/**
 * スポット回収_医院用ヘッダー
 */
const SPOT_CLINIC_HEADERS = [
  'タイムスタンプ','メールアドレス',
  '代表電話番号','担当者名','依頼種別',
  '医院名','医院電話番号','郵便番号','住所',
  '休診日','午前休診','午後休診','回収不可能時間',
  '医療機器_有無','医療機器_名称数量','医療機器_写真','医療機器_詳細','医療機器_備考',
  '什器備品_名称数量','家電_名称数量','什器家電_写真','什器家電_備考',
  '書類_梱包済み','書類_梱包依頼','書類_混在物','書類_階数','書類_溶解証明',
  '書類_ダンボール数','書類_写真','書類_備考',
  '廃液薬品_名称容量数量','廃液薬品_写真','廃液薬品_備考',
  'その他廃棄物',
  '移転閉院_予定有無','移転閉院_詳細',
  'その他質問補足'
];

/**
 * スポット回収_ディーラー用ヘッダー
 */
const SPOT_DEALER_HEADERS = [
  'タイムスタンプ','メールアドレス',
  'ディーラー電話番号','依頼種別',
  '会社名','支店名','部署名','ディーラー担当者名',
  '医院名','医院担当者名','医院電話番号','郵便番号','住所',
  '希望日_入力','希望日選択',
  '医療機器_有無','医療機器_名称数量','医療機器_詳細','医療機器_写真',
  '医療機器_取外し','医療機器_搬出対応','医療機器_階数','医療機器_EV','医療機器_駐車場','医療機器_備考',
  '什器備品_名称数量','家電_名称数量','什器家電_写真',
  '什器家電_取外し','什器家電_搬出対応','什器家電_階数','什器家電_EV','什器家電_駐車場','什器家電_備考',
  '書類_梱包済み','書類_梱包依頼','書類_混在物','書類_階数','書類_溶解証明',
  '書類_ダンボール数','書類_写真','書類_備考',
  '廃液薬品_名称容量数量','廃液薬品_写真','廃液薬品_備考',
  'その他廃棄物',
  '移転閉院_予定有無','移転閉院_詳細',
  'その他質問補足'
];

/**
 * フォームヘッダーのエイリアス定義 - 定期回収用
 */
const DEST_ALIASES = {
  'タイムスタンプ': ['タイムスタンプ'],
  'メールアドレス': ['メールアドレス'],
  '電話番号': ['医院の電話番号を入力してください','医院の電話番号を入力してください。'],
  '医院名': ['医院名を入力してください。','医院名を入力してください','病医院名を入力してください。','病医院名を入力してください。（正式名称必須）'],
  '担当者名': ['担当者名を入力してください。','担当者名を入力してください','ご担当者名を入力してください。','ご担当者名を入力してください','ご入力者様のお名前（ご氏名）'],
  '郵便番号': ['郵便番号を入力してください。','郵便番号を入力してください'],
  '住所': ['ご住所を入力してください。','ご住所を入力してください','番地以下の情報を入力してください。','番地以下の情報を入力してください'],
  '休診日': ['回収が不可能な日（休診日など）を選択してください。 [休診日]'],
  '午前休診': ['回収が不可能な日（休診日など）を選択してください。 [午前休診]'],
  '午後休診': ['回収が不可能な日（休診日など）を選択してください。 [午後休診]'],
  '回収不可能時間': ['回収不可能時間（お昼休みなど）を記入してください。','回収を避けて欲しい時間（お昼休みなど）を記入してください。'],
  '50L容器': ['50ℓの回収物の個数を入力してください。','50Lの回収物の個数を入力してください。'],
  '30L容器': ['30ℓの回収物の個数を入力してください。','30Lの回収物の個数を入力してください。'],
  '20L容器': ['20ℓの回収物の個数を入力してください。','20Lの回収物の個数を入力してください。'],
  '感染性廃棄物': ['感染性廃棄物ダンボール箱の回収をご希望される場合は個数を入力してください。','感染性廃棄物ダンボール箱の回収をご希望される場合はご希望の回収個数を入力してください。'],
  '廃棄物種類': ['廃棄物の種類を選択してください。','回収をご希望される廃棄物を選択してください。'],
  '廃プラ袋': ['廃プラスチック類 45ℓビニール袋の回収個数を入力してください。','廃棄プラスチック類 45ℓビニール袋の回収個数を入力してください。'],
  '印象歯袋': ['【歯科用】印象歯 45ℓビニール袋の回収個数を入力してください。','【歯科用】印象歯 45ℓビニール袋の回収個数を入力してください。'],
  'ガラス袋': ['ガラスくず 45ℓビニール袋の回収個数を入力してください。','ガラスくず・石膏くず 45ℓビニール袋のご希望の回収個数を入力して下さい。','ガラスくず・石膏くず45ℓビニール袋のご希望の回収個数を入力して下さい。'],
  '石膏くず袋': ['【歯科/技工所用】石膏くず 45ℓビニール袋の回収個数を入力してください。','【歯科/技工所用】石膏くず 45ビニール袋の回収個数を入力してください。','【歯科/技工所用】石膏くず 45ビニール袋の回収個数を入力してください。'],
  '現像液': ['現像液の回収個数を入力してください。'],
  '定着液': ['定着液の回収個数を入力してください。','定着液の個数 定着液の回収個数を入力してください。'],
  '金属くず袋': ['金属くず 45ℓビニール袋の個数を入力してください。'],
  '写真1': ['【1】回収物の写真をアップロードしてください。','回収物の写真をアップロードしてください。'],
  '不要品詳細': ['廃棄されたい不要品の名称・数量を可能な範囲でお教えください。'],
  '備考': ['その他、ご質問やお問い合わせがございましたらご記入ください。']
};

/**
 * スポット回収_医院用エイリアス定義
 */
const SPOT_CLINIC_ALIASES = {
  'タイムスタンプ': ['タイムスタンプ'],
  'メールアドレス': ['メールアドレス'],
  '代表電話番号': ['【1-1】代表電話番号をご入力ください。'],
  '担当者名': ['【1-2】  ご担当者様名をご入力ください。'],
  '依頼種別': ['【1-3】  今回のご依頼についてお教えください。'],
  '医院名': ['【2-2】  病医院名を入力してください。（正式名称必須）'],
  '医院電話番号': ['【2-3】  代表電話番号を入力してください'],
  '郵便番号': ['【2-4】  郵便番号を入力してください。'],
  '住所': ['【2-5】  ご住所を入力してください。', '【2-6】  番地以下の情報を入力してください。'],
  '医療機器_有無': ['【3-1】'],
  '医療機器_名称数量': ['【4-2】  機器の名称・数量をご入力ください'],
  '医療機器_写真': ['【4-3】 回収物の写真をアップロード'],
  '医療機器_詳細': ['【4-4】  機器の詳細情報をご入力ください'],
  '医療機器_備考': ['【4-5】'],
  '什器備品_名称数量': ['【5-2】  什器・備品の名称・数量をご入力ください。'],
  '家電_名称数量': ['【5-3】  家電製品の名称・数量をご入力ください。'],
  '什器家電_写真': ['【5-4】 回収物の写真をアップロード'],
  '什器家電_備考': ['【5-5】'],
  '書類_梱包済み': ['【6-1】  書類の廃棄に関してのご質問 [書類はダンボールに梱包されていますか？]'],
  '書類_梱包依頼': ['【6-1】  書類の廃棄に関してのご質問 [梱包作業をビルズにお任せしますか？]'],
  '書類_混在物': ['【6-1】  書類の廃棄に関してのご質問 [紙以外のもの（ファイル・カード・ＣＤｰＲ等）も混ざっていますか？]'],
  '書類_階数': ['【6-1】  書類の廃棄に関してのご質問 [保管場所の階数は１階ですか？]'],
  '書類_溶解証明': ['【6-1】  書類の廃棄に関してのご質問 [溶解証明書は必要ですか？]'],
  '書類_ダンボール数': ['【6-2】  ダンボールに梱包されている場合、個数をご入力ください。（おおよそでも構いません）'],
  '書類_写真': ['【6-3】 回収物の写真をアップロード'],
  '書類_備考': ['【6-3】'],
  '廃液薬品_名称容量数量': ['【7-1】  廃液・薬品の名称・容量・数量をご入力ください。'],
  '廃液薬品_写真': ['【7-2】  回収物の写真をアップロード'],
  '廃液薬品_備考': ['【7-3】'],
  'その他廃棄物': ['【8-2】  わかる範囲で廃棄予定品をお教えください。'],
  '移転閉院_予定有無': ['【9-1】'],
  '移転閉院_詳細': ['【9-2】  上記の項目で、場所や時期など決定している情報があればご記入ください。'],
  'その他質問補足': ['【10-1】  その他、ご質問や補足事項などがございましたら自由にご入力ください。']
};

/**
 * スポット回収_ディーラー用エイリアス定義
 */
const SPOT_DEALER_ALIASES = {
  'タイムスタンプ': ['タイムスタンプ'],
  'メールアドレス': ['メールアドレス'],
  'ディーラー電話番号': ['【1-1】  ご担当者様のお電話番号をご入力ください。'],
  '依頼種別': ['【1-2】今回のご依頼についてお教えください。'],
  '会社名': ['【2-2】会社名をご入力ください。'],
  '支店名': ['【2-3】支店名をご入力ください。'],
  '部署名': ['【2-4】部署名をご入力ください。'],
  'ディーラー担当者名': ['【2-5】  ご担当者様のお名前をご入力ください。'],
  '医院名': ['【3-1】医療機関名を入力してください。（正式名称必須）'],
  '医院担当者名': ['【3-2】  医療機関のご担当者様名を入力してください。'],
  '医院電話番号': ['【3-3】  電話番号を入力してください。'],
  '郵便番号': ['【3-3】  郵便番号を入力してください。'],
  '住所': ['【3-4】  ご住所を入力してください。', '【3-5】  番地以下の情報を入力してください。'],
  '希望日_入力': ['【4-1】  回収のご希望日についてご入力ください'],
  '希望日選択': ['【4-2】  回収ご希望日を選択してください。'],
  '医療機器_有無': ['【5-1】'],
  '医療機器_名称数量': ['【6-1】  機器の名称・数量をご入力ください'],
  '医療機器_詳細': ['【6-2】  機器の詳細情報を入力してください'],
  '医療機器_写真': ['【6-3】  回収物の写真をアップロードしてください。'],
  '医療機器_取外し': ['【6-4】  搬出時の対応について [取り外し作業は必要でしょうか？]'],
  '医療機器_搬出対応': ['【6-4】  搬出時の対応について [搬出作業も対応した方がよろしいでしょうか？]'],
  '医療機器_階数': ['【6-4】  搬出時の対応について [搬出場所は1階でよろしいでしょうか？]'],
  '医療機器_EV': ['【6-4】  搬出時の対応について [2階以上の場合EVの使用は可能でしょうか？]'],
  '医療機器_駐車場': ['【6-4】  搬出時の対応について [駐車場の確保は可能でしょうか？]'],
  '医療機器_備考': ['【6-5】'],
  '什器備品_名称数量': ['【7-1】  什器・備品の名称・数量をご入力ください。'],
  '家電_名称数量': ['【7-2】  家電製品の名称・数量などをご入力ください。'],
  '什器家電_写真': ['【7-3】  回収物の写真をアップロードしてください。'],
  '什器家電_取外し': ['【7-4】  搬出時の対応について [取り外し作業は必要でしょうか？]'],
  '什器家電_搬出対応': ['【7-4】  搬出時の対応について [搬出作業も対応した方がよろしいでしょうか？]'],
  '什器家電_階数': ['【7-4】  搬出時の対応について [搬出場所は1階でよろしいでしょうか？]'],
  '什器家電_EV': ['【7-4】  搬出時の対応について [2階以上の場合EVの使用は可能でしょうか？]'],
  '什器家電_駐車場': ['【7-4】  搬出時の対応について [駐車場の確保は可能でしょうか？]'],
  '什器家電_備考': ['【7-5】'],
  '書類_梱包済み': ['【8-1】  書類の廃棄に関してのご質問 [書類はダンボールに梱包されていますか？]'],
  '書類_梱包依頼': ['【8-1】  書類の廃棄に関してのご質問 [梱包作業をビルズにお任せしますか？]'],
  '書類_混在物': ['【8-1】  書類の廃棄に関してのご質問 [紙以外のもの（ファイル・カード・ＣＤｰＲ等）も混ざっていますか？]'],
  '書類_階数': ['【8-1】  書類の廃棄に関してのご質問 [保管場所の階数は１階ですか？]'],
  '書類_溶解証明': ['【8-1】  書類の廃棄に関してのご質問 [溶解証明書は必要ですか？]'],
  '書類_ダンボール数': ['【8-2】ダンボールに梱包されている場合、個数をご入力ください。（おおよそでも構いません）'],
  '書類_写真': ['【8-3】 回収物の写真をアップロードしてください。'],
  '書類_備考': ['【8-4】'],
  '廃液薬品_名称容量数量': ['【9-2】  廃液・薬品の名称・容量・数量をご入力ください。'],
  '廃液薬品_写真': ['【9-3】  回収物の写真をアップロードしてください。'],
  '廃液薬品_備考': ['【9-4】'],
  'その他廃棄物': ['【10-1】  お分かりになる範囲で廃棄予定品をお教えください。'],
  '移転閉院_予定有無': ['【11-1】'],
  '移転閉院_詳細': ['【11-2】  上記の項目で、場所や時期など決定している情報があればご記入ください。'],
  'その他質問補足': ['【12-1】  その他、ご質問や補足事項などがございましたら自由にご入力ください。']
};

/**
 * 顧客マスタ関連定数
 */
const CUSTOMER_FILL_HEADERS = [
  '担当者名','医院名','電話番号','郵便番号','住所',
  '休診日','午前休診','午後休診','回収不可能時間'
];

const CUSTOMER_MASTER_KEY_HEADER = '電話番号';
const CUSTOMER_MASTER_HEADERS = [CUSTOMER_MASTER_KEY_HEADER].concat(CUSTOMER_FILL_HEADERS, ['メールアドレス']);

/**
 * ディーラーマスタ補完対象ヘッダー
 */
const DEALER_FILL_HEADERS = [
  '会社名','支店名','部署名','ディーラー担当者名','ディーラー電話番号'
];
const DEALER_MASTER_HEADERS = [DEALER_CONFIG.keyHeader].concat(DEALER_FILL_HEADERS, ['メールアドレス']);